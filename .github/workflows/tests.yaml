name: "action-test"
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      target:
        description: "path to the target to scan"
        default: "."
        required: false
      output_dir:
        description: "path to store the sbom"
        default: "/tmp/sbom"
        required: false
      vuln_report:
        description: "Generate vulnerability report"
        default: false
        required: false
        type: boolean

# Redefining those var via the env because when this workflow
# is triggered on push or pull_request event, the default value
# of the inputs is not set.
env:
  TARGET: "${{ inputs.target || '.' }}"
  OUTPUT_DIR: "${{ inputs.output_dir || '/tmp/sbom' }}"
  VULN_REPORT: "${{ inputs.vuln_report || false }}"

jobs:
  test-as-action:
    runs-on: ubuntu-22.04
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ./

      - name: Download artifact
        shell: bash
        run: curl -o /tmp/Core-15.0.iso https://distro.ibiblio.org/tinycorelinux/15.x/x86/release/Core-15.0.iso

      - name: Scan repo
        uses: ./
        with:
          target: ${{ env.TARGET }}
          output_dir: ${{ env.OUTPUT_DIR }}
          vuln_report: True

      - name: Scan iso
        uses: ./
        with:
          target: /tmp/Core-15.0.iso
          output_dir: ${{ env.OUTPUT_DIR }}
          vuln_report: True

      - name: Print the content of generated sbom file
        shell: bash
        run: |
          for sbom in /tmp/sbom/*.json; do
            echo "Content of $sbom"
            cat $sbom
          done
          for sbom in /tmp/sbom/reports/*.html; do
            echo "Content of vulnerability result for SBOM: $sbom"
            cat $sbom
          done
