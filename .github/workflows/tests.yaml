name: "action-test"
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      target:
        description: "path to the target to scan"
        default: "."
        required: false
      output_dir:
        description: "path to store the sbom"
        default: "/tmp/sbom"
        required: false
      vuln_report:
        description: "Generate vulnerability report"
        default: "False"
        required: false

jobs:

  test-as-action:
    runs-on: ubuntu-22.04
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ./
      
      - name: Download artifact
        shell: bash
        run: curl -o /tmp/Core-15.0.iso https://distro.ibiblio.org/tinycorelinux/15.x/x86/release/Core-15.0.iso

      - name: Scan repo
        uses: ./
        with:
          target: ${{ inputs.target }}
          output_dir: ${{ inputs.output_dir }}
          vuln_report: True

      - name: Scan iso
        uses: ./
        with:
          target: /tmp/Core-15.0.iso
          output_dir: ${{ inputs.output_dir }}
          vuln_report: True

      - name: Print the content of generated sbom file
        shell: bash
        run: |
          for sbom in /tmp/sbom/*.json; do
            echo "Content of $sbom"
            cat $sbom
          done
          for sbom in /tmp/sbom/reports/*.html; do
            echo "Content of vulnerability result for SBOM: $sbom"
            cat $sbom
          done
